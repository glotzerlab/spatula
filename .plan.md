# Plan: Implement Single Precision for PGOP with Templating

## Overview
Convert PGOP to use single-precision (float) while maintaining double-precision for BOOSOP through templating of core data structures.

## Files Requiring Changes

### 1. Template Vec3, typedef Vec3f and Vec3d, then implement those changes where needed

**File: `src/data/Vec3.h`**
- Template `Vec3<T>` where T is float or double
- Add typedefs: `using Vec3f = Vec3<float>;` and `using Vec3d = Vec3<double>;`
- Template all member functions (`dot`, `norm`, `normalize`, `cross`, `operator[]`)
- Template all operators (`+`, `-`, `*`, `/`, `+=`, `-=`, `*=`, `/=`, `==`)
- Keep existing double behavior as default via `Vec3d`

**Files that use Vec3 and need template awareness:**
- `src/data/RotationMatrix.h` - Vec3 used in `rotate()` method and `from_vec3()` static method
- `src/data/Quaternion.h` - Vec3 used in constructors and return values

### 2. Implement templates for RotationMatrix as well, then implement

**File: `src/data/RotationMatrix.h`**
- Template `RotationMatrix<T>` inheriting from `std::array<T, 9>`
- Add typedefs: `using RotationMatrixf = RotationMatrix<float>;` and `using RotationMatrixd = RotationMatrix<double>;`
- Template `rotate()` method to return `Vec3<T>`
- Template `from_vec3()` static method to accept `Vec3<T>&`

**Files that use RotationMatrix and need template awareness:**
- `src/data/Quaternion.h` - `to_rotation_matrix()` returns `RotationMatrix<double>`
- `src/util/Util.h` - `rotate_matrix()`, `single_rotate()`, `to_rotation_matrix()`

### 3. Update the remaining utils if necessary

**File: `src/util/Util.h`**
- Template `vec3_iter` and `cvec3_iter` typedefs
- Template `fast_angle_eucledian()` to accept `Vec3<T>` parameters
- Template `single_rotate()` to accept `Vec3<T>&` and `RotationMatrix<T>`
- Template `rotate_matrix()` to use templated iterators and `RotationMatrix<T>`
- Template `to_rotation_matrix()` to accept `Vec3<T>` and return `RotationMatrix<T>`
- Template `normalize_distances()` to return `std::vector<Vec3<T>>`

**File: `src/util/Metrics.h`**
- Template `compute_Bhattacharyya_coefficient_gaussian()` to accept `Vec3<T>`
- Template `compute_log_m_Bhattacharyya_coefficient_gaussian()` to accept `Vec3<T>`
- Template `compute_Bhattacharyya_coefficient_fisher()` to accept `Vec3<T>`
- Template `compute_Bhattacharyya_coefficient_fisher_normalized()` to accept `Vec3<T>`

**File: `src/data/Quaternion.h`**
- Consider templating Quaternion to `Quaternion<T>` for consistency (optional, can stay double)

### 4. Template locality, ensuring the calling code is correct in both BOOSOP and PGOP

**File: `src/locality.h`**
- Template `LocalNeighborhood<T>` class
  - Template `positions` and `rotated_positions` to be `std::vector<Vec3<T>>`
  - Keep `weights` and `sigmas` as `std::span<const double>` (weights/sigmas remain double)
- Template `Neighborhoods` to return `LocalNeighborhood<T>` from `getNeighborhood()`
- Add typedefs: `using LocalNeighborhoodf = LocalNeighborhood<float>;` `using LocalNeighborhoodd = LocalNeighborhood<double>;`

**Files that use LocalNeighborhood:**
- `src/PGOP.cc` and `src/PGOP.h` - will use `LocalNeighborhoodf`
- `src/BOOSOP.cc` and `src/BOOSOP.h` - will use `LocalNeighborhoodd`

### 5. Implement the changes to PGOP (not templated, fixed to single precision)

**File: `src/PGOP.h`**
- Change return type from `std::tuple<double, data::Vec3>` to `std::tuple<double, data::Vec3f>` in `compute_symmetry()`
- All other methods return double or Quaternion (no change needed)

**File: `src/PGOP.cc`**
- Use `LocalNeighborhoodf` instead of `LocalNeighborhood`
- Update `Neighborhoods` to return `LocalNeighborhoodf` (may need to template `getNeighborhood()`)

**Note:** The `compute_symmetry` method returns `data::Vec3` which becomes the rotation axis. This can be float since the final rotation is converted to Quaternion (double) for output.

### 6. Update computes.h

**File: `src/computes.h`**
- Template all four compute functions to accept `LocalNeighborhood<T>&`
  - `compute_pgop_gaussian<T>()`
  - `compute_pgop_gaussian_fast<T>()`
  - `compute_pgop_fisher<T>()`
  - `compute_pgop_fisher_fast<T>()`
- Update function bodies to work with `Vec3<T>` (should work via templated operators)

**File: `src/PGOP.cc`**
- Update calls to compute functions to explicitly specify template parameter `<float>`

### Summary of Type Usage

| Component | BOOSOP | PGOP |
|-----------|--------|------|
| Vec3 | Vec3d (double) | Vec3f (float) |
| RotationMatrix | RotationMatrixd | RotationMatrixf |
| LocalNeighborhood | LocalNeighborhoodd | LocalNeighborhoodf |
| weights/sigmas | double | double |
| Quaternion | double | double |
| return values | double | double |

## Implementation Order

1. **Chunk 1:** Template Vec3 with typedefs (data/Vec3.h)
2. **Chunk 2:** Template RotationMatrix with typedefs (data/RotationMatrix.h)
3. **Chunk 3:** Update Util.h and Metrics.h utility functions
4. **Chunk 4:** Template LocalNeighborhood and Neighborhoods (locality.h)
5. **Chunk 5:** Update PGOP.h and PGOP.cc to use float variants
6. **Chunk 6:** Update computes.h to template functions and update calls in PGOP.cc
